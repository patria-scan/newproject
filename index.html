<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Control de Expedientes</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style> /* Tu CSS se mantiene igual */ </style>
</head>
<body>
    <main class="app-container">
        <header>
            <h1><i data-feather="package"></i>Control de Expedientes</h1>
        </header>

        <div class="card">
            <div class="form-group">
                <label for="user-select">¿Quién envía?</label>
                <div class="select-wrapper">
                    <select id="user-select">
                        <option value="">-- Seleccionar tu nombre --</option>
                        <option value="Juan Perez">Juan Perez</option>
                        <option value="Maria Rodriguez">Maria Rodriguez</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="action-select">¿Qué acción se realiza?</label>
                <div class="select-wrapper">
                    <select id="action-select">
                        <option value="">-- Seleccionar destino o acción --</option>
                        <option value="Recibido en Archivo">Recibido en Archivo</option>
                        <option value="Enviado a Contabilidad">Enviado a Contabilidad</option>
                    </select>
                </div>
            </div>

            <div id="reader"></div>
            <div id="feedback"></div>
        </div>
    </main>
    <footer>© <span id="year"></span> Sistema de Control de Expedientes.</footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const googleAppScriptUrl = 'https://script.google.com/macros/s/AKfycbwNjFEX-BSPJb3hkeQPk7M9UycvbZOyn5PRlZs4BY3fF7MRtNTXbGcHtambIskWmmMbuQ/exec';

            // --- ELEMENTOS DEL DOM (SIMPLIFICADO) ---
            const userSelect = document.getElementById('user-select');
            const actionSelect = document.getElementById('action-select');
            const readerDiv = document.getElementById('reader');
            const feedbackDiv = document.getElementById('feedback');
            document.getElementById('year').textContent = new Date().getFullYear();
            feather.replace();

            let isProcessing = false;

            const SELECTION_KEYS = { user: 'expedientes_user', action: 'expedientes_action' };
            const saveSelections = () => {
                localStorage.setItem(SELECTION_KEYS.user, userSelect.value);
                localStorage.setItem(SELECTION_KEYS.action, actionSelect.value);
            };
            const loadSelections = () => {
                userSelect.value = localStorage.getItem(SELECTION_KEYS.user) || '';
                actionSelect.value = localStorage.getItem(SELECTION_KEYS.action) || '';
            };

            function showFeedback(message, type, duration = 4000) { /* ... sin cambios ... */ }

            async function sendData(barcodeData) {
                const user = userSelect.value;
                const action = actionSelect.value;
                
                if (!user || !action) {
                    showFeedback('Por favor, selecciona tu nombre y la acción a realizar.', 'error');
                    isProcessing = false; // Desbloquear para permitir un nuevo intento
                    return;
                }

                showFeedback(`Procesando código ${barcodeData}...`, 'processing', 0);

                try {
                    const response = await fetch(googleAppScriptUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            barcodeData: barcodeData, // Enviamos el dato crudo del código de barras
                            nombre: user,
                            accion: action
                        }),
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        showFeedback(`✅ ¡Éxito! ${result.message}`, 'success');
                    } else {
                        showFeedback(`❌ Error: ${result.message}`, 'error');
                    }
                } catch (error) {
                    showFeedback('Error de conexión. Revisa tu internet o la URL del script.', 'error');
                } finally {
                    setTimeout(() => { isProcessing = false; }, 2500); // Reducido el tiempo de espera
                }
            }
            
            function onScanSuccess(decodedText, decodedResult) {
                if (isProcessing) return;
                isProcessing = true;
                if (navigator.vibrate) navigator.vibrate(100);
                sendData(decodedText);
            }

            // --- INICIALIZACIÓN DEL ESCÁNER ---
            loadSelections();
            userSelect.addEventListener('change', saveSelections);
            actionSelect.addEventListener('change', saveSelections);

            // Configuración del escáner para Code 128
            const html5QrcodeScanner = new Html5QrcodeScanner(
                "reader", 
                { 
                    fps: 10, 
                    qrbox: { width: 280, height: 100 }, // Rectángulo más ancho para Code 128
                    formatsToSupport: [ Html5QrcodeSupportedFormats.CODE_128 ]
                },
                /* verbose= */ false
            );
            
            html5QrcodeScanner.render(onScanSuccess, (error) => {});
            readerDiv.classList.add('scanning');
        });
    </script>
</body>
</html>


