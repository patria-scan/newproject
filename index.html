/**
 * @file Código.gs
 * @description Backend profesional y robusto para el control de expedientes mediante escaneo de códigos de barras.
 * @version 3.0
 * @author Gemini
 */

// --- CONFIGURACIÓN CENTRALIZADA ---
const CONFIG = {
  SHEET_NAME: "EXP SD-2025", // Nombre de la pestaña de la hoja de cálculo
  USER_COLUMN: 2,           // Columna B para el nombre del usuario
  DATE_COLUMN: 3,           // Columna C para la fecha de la acción
  STATUS_COLUMN: 4,         // Columna D para el estatus (la acción seleccionada)
  TYPE_MAP: {
    '1': 'DPA',
    '2': 'DP'
  }
};

/**
 * Función principal que se ejecuta al recibir una solicitud POST desde el frontend.
 * @param {object} e - El objeto de evento de la solicitud POST.
 * @returns {ContentService.TextOutput} - Una respuesta en formato JSON.
 */
function doPost(e) {
  try {
    const requestData = JSON.parse(e.postData.contents);
    const { barcodeData, nombre, accion } = requestData;

    if (!barcodeData || !nombre || !accion) {
      return createJsonResponse({
        status: "error",
        message: "Datos incompletos. Se requiere código, nombre y acción."
      });
    }

    const parts = barcodeData.split('-');
    if (parts.length !== 2) {
      return createJsonResponse({
        status: "error",
        message: `Formato de código inválido. Se esperaba 'fila-tipo', se recibió: ${barcodeData}`
      });
    }

    const rowNumber = parseInt(parts[0], 10);
    const typeIndicator = parts[1];
    const expedienteType = CONFIG.TYPE_MAP[typeIndicator];

    if (isNaN(rowNumber) || rowNumber <= 1) {
      return createJsonResponse({
        status: "error",
        message: `Número de fila inválido en el código: ${parts[0]}`
      });
    }

    if (!expedienteType) {
      return createJsonResponse({
        status: "error",
        message: `Tipo de expediente inválido en el código: ${typeIndicator}. Válidos: 1 o 2.`
      });
    }

    // --- Lógica mejorada: Obtener o crear la hoja de cálculo ---
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName(CONFIG.SHEET_NAME);
    if (!sheet) {
      sheet = ss.insertSheet(CONFIG.SHEET_NAME);
      // Opcional: Agregar encabezados si la hoja es nueva
      sheet.getRange(1, 1, 1, 4).setValues([["Código Completo", "Usuario", "Fecha", "Estatus"]]);
    }
    
    // Preparar los datos y actualizar la fila
    const today = new Date();
    const rangeToUpdate = sheet.getRange(rowNumber, CONFIG.USER_COLUMN, 1, 3);

    rangeToUpdate.setValues([[
      nombre,
      today,
      accion
    ]]);

    return createJsonResponse({
      status: "success",
      message: `Fila ${rowNumber} (${expedienteType}) actualizada. Estado: ${accion}`
    });

  } catch (error) {
    Logger.log(error.toString());
    return createJsonResponse({
      status: "error",
      message: "Ocurrió un error inesperado en el servidor. Contacte al administrador."
    });
  }
}

/**
 * Sirve el archivo HTML principal cuando se accede a la URL del script.
 * @param {object} e - El objeto de evento de la solicitud GET.
 * @returns {HtmlService.HtmlOutput} - La página web.
 */
function doGet(e) {
  return HtmlService.createHtmlOutputFromFile('Index')
    .setTitle("Control de Expedientes v3.0")
    .addMetaTag('viewport', 'width=device-width, initial-scale=1.0, viewport-fit=cover');
}

/**
 * Crea una respuesta JSON estandarizada.
 * @param {object} data - El objeto a convertir en JSON.
 * @returns {ContentService.TextOutput} - La respuesta JSON.
 */
function createJsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}
