<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escáner de Expedientes</title>
    <link rel="icon" type="image/png" href="https://github.com/patria-scan/newproject/blob/main/favicon.png?raw=true">
    
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {
            --primary-color: #4285F4; --success-color: #0F9D58;
            --error-color: #DB4437; --warning-color: #F4B400;
            --bg-color: #f5f5f5; --text-color: #333;
            --card-bg: #ffffff; --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 1rem; background-color: var(--bg-color);
            color: var(--text-color); display: flex; justify-content: center;
            align-items: flex-start; min-height: 100vh;
        }
        main {
            width: 100%; max-width: 500px; background-color: var(--card-bg);
            border-radius: var(--border-radius); box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        .header {
            background-color: var(--primary-color); color: white; padding: 1rem 1.5rem;
            display: flex; align-items: center; gap: 0.75rem;
        }
        h1 { margin: 0; font-size: 1.5rem; }
        .controls { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 0.5rem; color: #555; }
        select {
            width: 100%; padding: 0.75rem; border: 1px solid #ccc;
            border-radius: var(--border-radius); font-size: 1rem; background-color: #fff;
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12' 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1.2em;
        }
        #reader { width: 100%; border-top: 1px solid #eee; }
        #reader video { width: 100% !important; height: auto !important; }
        .feedback {
            padding: 1rem 1.5rem; font-weight: 500; display: none; text-align: center;
            opacity: 0; transition: opacity 0.3s ease-in-out;
        }
        .feedback.show { display: block; opacity: 1; }
        .feedback.success { background-color: var(--success-color); color: white; }
        .feedback.error { background-color: var(--error-color); color: white; }
        .feedback.processing { background-color: var(--warning-color); color: var(--text-color); }
    </style>
</head>
<body>

    <main>
        <header class="header">
            <i data-feather="grid"></i>
            <h1>Registro de Expedientes</h1>
        </header>

        <div class="controls">
            <div class="form-group">
                <label for="nombreUsuario">1. Seleccione su Usuario</label>
                <select id="nombreUsuario">
                    <option value="">-- Seleccione un nombre --</option>
                    <option value="ANNY SALAZAR">ANNY SALAZAR</option>
                    <option value="CARLENYS THOMPSON">CARLENYS THOMPSON</option>
                    <option value="CAROLINE QUEZADA">CAROLINE QUEZADA</option>
                    <option value="ELBA GOMEZ">ELBA GOMEZ</option>
                    <option value="EMMANUEL MARTE GUERRERO">EMMANUEL MARTE GUERRERO</option>
                    <option value="ESTRELLA MASSIEL CHALAS OCHOA">ESTRELLA MASSIEL CHALAS OCHOA</option>
                    <option value="FEDERICO CARLOS TORIBIO AMARO">FEDERICO CARLOS TORIBIO AMARO</option>
                    <option value="FELIX ORTIZ">FELIX ORTIZ</option>
                    <option value="ISAMAR ROSARIO">ISAMAR ROSARIO</option>
                    <option value="LAURA ESTHER GUZMAN">LAURA ESTHER GUZMAN</option>
                    <option value="LEO DIAZ">LEO DIAZ</option>
                    <option value="MIGUEL CORDERO">MIGUEL CORDERO</option>
                    <option value="REYNELD ABREU">REYNELD ABREU</option>
                    <option value="RAMONA DURAN">RAMONA DURAN</option>
                    <option value="SHARLINNE HEYER">SHARLINNE HEYER</option>
                    <option value="YORGELIS DE LOS SANTOS">YORGELIS DE LOS SANTOS</option>
                </select>
            </div>

            <div class="form-group">
                <label for="accion">2. Seleccione la Acción</label>
                <select id="accion">
                    <option value="">-- Seleccione una acción --</option>
                    <option value="ARCHIVADO">ARCHIVADO</option>
                    <option value="PASADO A">PASADO A</option>
                    <option value="EN MI PODER">EN MI PODER</option>
                    <option value="ENVIADO A TESORERIA">ENVIADO A TESORERIA</option>
                    <option value="ENVIADO A TASACION">ENVIADO A TASACION</option>
                    <option value="PASADO A LEO PARA ARCHIVAR">PASADO A LEO PARA ARCHIVAR</option>
                </select>
            </div>

            <div class="form-group" id="pasadoAContainer" style="display: none;">
                <label for="pasadoAUsuario">Pasado a:</label>
                <select id="pasadoAUsuario">
                     <option value="">-- Seleccione usuario destino --</option>
                </select>
            </div>
        </div>
        
        <p style="text-align: center; padding: 0 1.5rem; margin-top: -1rem; color: #555;">3. Apunte la cámara al código</p>
        <div id="reader"></div>
        
        <div id="feedback" class="feedback"></div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();

            const nombreSelect = document.getElementById('nombreUsuario');
            const accionSelect = document.getElementById('accion');
            const pasadoAContainer = document.getElementById('pasadoAContainer');
            const pasadoAUsuarioSelect = document.getElementById('pasadoAUsuario');
            const feedbackDiv = document.getElementById('feedback');
            const html5QrCode = new Html5Qrcode("reader");
            let feedbackTimeout;
            
            Array.from(nombreSelect.options).forEach(option => {
                if (option.value) {
                    pasadoAUsuarioSelect.appendChild(option.cloneNode(true));
                }
            });

            accionSelect.addEventListener('change', () => {
                if (accionSelect.value === 'PASADO A') {
                    pasadoAContainer.style.display = 'flex';
                } else {
                    pasadoAContainer.style.display = 'none';
                    pasadoAUsuarioSelect.value = "";
                }
            });

            const savedNombre = localStorage.getItem('scannerApp_nombre');
            const savedAccion = localStorage.getItem('scannerApp_accion');
            if (savedNombre) nombreSelect.value = savedNombre;
            if (savedAccion) {
                accionSelect.value = savedAccion;
                accionSelect.dispatchEvent(new Event('change'));
            }

            nombreSelect.addEventListener('change', () => localStorage.setItem('scannerApp_nombre', nombreSelect.value));
            accionSelect.addEventListener('change', () => localStorage.setItem('scannerApp_accion', accionSelect.value));

            function showFeedback(message, type, duration = 4000) {
                clearTimeout(feedbackTimeout);
                feedbackDiv.textContent = message;
                feedbackDiv.className = `feedback ${type} show`;
                if (type !== 'processing') {
                    feedbackTimeout = setTimeout(() => feedbackDiv.classList.remove('show'), duration);
                }
            }
            
            const onScanSuccess = (decodedText, decodedResult) => {
                html5QrCode.pause();
                
                const nombre = nombreSelect.value;
                let accion = accionSelect.value;

                if (!nombre || !accion) {
                    showFeedback('Error: Debe seleccionar un usuario y una acción.', 'error');
                    setTimeout(() => html5QrCode.resume(), 1500);
                    return;
                }
                
                let finalAccion = accion;
                
                if (accion === 'PASADO A') {
                    const usuarioDestino = pasadoAUsuarioSelect.value;
                    if (!usuarioDestino) {
                        showFeedback('Error: Debe seleccionar un usuario de destino.', 'error');
                        setTimeout(() => html5QrCode.resume(), 1500);
                        return;
                    }
                    finalAccion = `Pasado a ${usuarioDestino}`;
                }

                showFeedback('Procesando...', 'processing');

                const data = {
                    barcodeData: decodedText,
                    nombre: nombre,
                    accion: finalAccion
                };
                
                // ===== URL DEL SCRIPT ACTUALIZADA =====
                const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxOAhkmFQ204Nhy1lVw7NOi256grHZ93p0N38AL0G0umBmHZpYxnHXxLHHteiOdOKlZHg/exec';

                fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                })
                .then(response => response.json())
                .then(response => {
                    if (response.status === 'success') {
                        showFeedback(response.message, 'success');
                    } else {
                        showFeedback(response.message, 'error', 6000);
                    }
                    setTimeout(() => html5QrCode.resume(), 1500);
                })
                .catch(error => {
                    showFeedback(`Error de comunicación: ${error.message}`, 'error', 6000);
                    setTimeout(() => html5QrCode.resume(), 1500);
                });
            };

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                facingMode: "environment", 
                formatsToSupport: [ Html5QrcodeSupportedFormats.DATA_MATRIX ]
            };

            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (error) => {})
                .catch(err => {
                    showFeedback('No se pudo iniciar la cámara. Verifique los permisos.', 'error');
                });
        });
    </script>
</body>
</html>

